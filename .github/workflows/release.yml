name: Reusable Release

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
        description: "Name of the image (e.g. booster, thruster)"
      languages:
        required: false
        type: string
        default: ""
        description: "Comma-separated list of languages (e.g. go,ts). Leave empty for Base/Single images."
      dockerfile:
        required: false
        type: string
        default: ./Dockerfile
      test_command:
        required: false
        type: string
        default: ""
      publish_to_dockerhub:
        required: false
        type: boolean
        default: false
      push_git_tag:
        required: false
        type: boolean
        default: false
      registry_username:
        required: false
        type: string
        default: ""

    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false
      JETSCALEBOT_GITHUB_TOKEN:
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ci-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run Tests
        if: inputs.test_command != ''
        run: ${{ inputs.test_command }}

      - name: Detect Local Run
        id: local_check
        run: |
          if [[ "${ACT:-}" == "true" ]]; then
            echo "is_local=true" >> "$GITHUB_OUTPUT"
            echo "suffix=-local" >> "$GITHUB_OUTPUT"
          else
            echo "is_local=false" >> "$GITHUB_OUTPUT"
            echo "suffix=" >> "$GITHUB_OUTPUT"
          fi

      - name: Semantic Release
        id: semrel
        if: steps.local_check.outputs.is_local != 'true'
        uses: go-semantic-release/action@v1
        with:
          github-token: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN != '' && secrets.JETSCALEBOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Fake version locally
        id: semrel_local
        if: steps.local_check.outputs.is_local == 'true'
        run: |
          echo "version=0.0.0-local" >> "$GITHUB_OUTPUT"

      - name: Check Secrets
        id: check_secrets
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          if [ -n "$DH_USER" ] && [ -n "$DH_TOKEN" ]; then
            echo "has_dockerhub=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_dockerhub=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to GHCR
        if: steps.semrel.outputs.version != '' || steps.local_check.outputs.is_local == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ inputs.registry_username != '' && inputs.registry_username || (secrets.JETSCALEBOT_GITHUB_TOKEN != '' && 'jetscalebot' || github.actor) }}
          password: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN != '' && secrets.JETSCALEBOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: (steps.semrel.outputs.version != '' || steps.local_check.outputs.is_local == 'true') && inputs.publish_to_dockerhub && steps.check_secrets.outputs.has_dockerhub == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Setup Docker Buildx
        if: steps.semrel.outputs.version != '' || steps.local_check.outputs.is_local == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Images
        if: steps.semrel.outputs.version != '' || steps.local_check.outputs.is_local == 'true'
        env:
          VERSION: ${{ steps.semrel.outputs.version || steps.semrel_local.outputs.version }}
          IMAGE_NAME: ${{ inputs.image_name }}
          OWNER: ${{ github.repository_owner }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          HAS_DOCKERHUB: ${{ steps.check_secrets.outputs.has_dockerhub }}
          SUFFIX: ${{ steps.local_check.outputs.suffix }}
        run: |
          OWNER_LC=$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')
          SHA_SHORT=$(git rev-parse --short HEAD)
          SHA_FULL=$(git rev-parse HEAD)
          BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

          # --- Helper: Generate Strict Tags ---
          # Output: comma-separated tags including :latest, :vX.Y.Z, :vX.Y, :vX, :sha-XXXX
          generate_tags() {
            local image_ghcr="$1"
            local image_dh="$2"
            local tags=""

            # Base Tags: Version + Latest + SHA
            local t_ghcr="${image_ghcr}:${VERSION}${SUFFIX},${image_ghcr}:latest${SUFFIX},${image_ghcr}:sha-${SHA_SHORT}${SUFFIX}"
            local t_dh=""
            if [[ -n "$image_dh" ]]; then
              t_dh="${image_dh}:${VERSION}${SUFFIX},${image_dh}:latest${SUFFIX},${image_dh}:sha-${SHA_SHORT}${SUFFIX}"
            fi

            # Semantic Aliases (only if not local suffix and version is strict semver)
            if [[ -z "$SUFFIX" && "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              local major=$(echo "$VERSION" | cut -d. -f1)
              local minor=$(echo "$VERSION" | cut -d. -f1,2)

              t_ghcr="${t_ghcr},${image_ghcr}:${major},${image_ghcr}:${minor}"
              if [[ -n "$image_dh" ]]; then
                t_dh="${t_dh},${image_dh}:${major},${image_dh}:${minor}"
              fi
            fi

            if [[ -n "$t_dh" ]]; then
              echo "${t_ghcr},${t_dh}"
            else
              echo "${t_ghcr}"
            fi
          }

          # --- 1. Language Variants Loop ---
          if [[ -n "${{ inputs.languages }}" ]]; then
            IFS=',' read -ra LANGS <<< "${{ inputs.languages }}"
            for lang in "${LANGS[@]}"; do
              lang_trimmed=$(echo "$lang" | xargs)
              echo "Processing language: $lang_trimmed"

              runtime_lang="$lang_trimmed"
              if [[ "$lang_trimmed" == "ts" ]]; then runtime_lang="js"; fi

              # DEV Image
              GHCR_DEV="ghcr.io/${OWNER_LC}/${IMAGE_NAME}-${lang_trimmed}-dev"
              DH_DEV=""
              if [[ "${{ inputs.publish_to_dockerhub }}" == "true" && "$HAS_DOCKERHUB" == "true" ]]; then
                 DH_DEV="docker.io/${DOCKERHUB_USERNAME}/${IMAGE_NAME}-${lang_trimmed}-dev"
              fi
              TAGS_DEV=$(generate_tags "$GHCR_DEV" "$DH_DEV")

              echo "Building Dev ($lang): ${TAGS_DEV}"
              docker buildx build \
                --file "${{ inputs.dockerfile }}" \
                --target "${IMAGE_NAME}-${lang_trimmed}-dev" \
                --build-arg "JETSCALE_VERSION=${VERSION}" \
                --build-arg "JETSCALE_GIT_SHA=${SHA_FULL}" \
                --build-arg "JETSCALE_BUILD_TIME=${BUILD_TIME}" \
                --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
                --label "org.opencontainers.image.version=${VERSION}" \
                --label "org.opencontainers.image.revision=${SHA_FULL}" \
                --label "org.opencontainers.image.created=${BUILD_TIME}" \
                --push \
                --cache-from type=gha,scope=dev-${lang_trimmed} \
                --cache-to type=gha,mode=max,scope=dev-${lang_trimmed} \
                $(echo "${TAGS_DEV}" | tr ',' '\n' | sed 's/^/--tag /') .

              # RUNTIME Image
              GHCR_RUN="ghcr.io/${OWNER_LC}/${IMAGE_NAME}-${runtime_lang}"
              DH_RUN=""
              if [[ "${{ inputs.publish_to_dockerhub }}" == "true" && "$HAS_DOCKERHUB" == "true" ]]; then
                 DH_RUN="docker.io/${DOCKERHUB_USERNAME}/${IMAGE_NAME}-${runtime_lang}"
              fi
              TAGS_RUN=$(generate_tags "$GHCR_RUN" "$DH_RUN")

              echo "Building Runtime ($lang): ${TAGS_RUN}"
              docker buildx build \
                --file "${{ inputs.dockerfile }}" \
                --target "${IMAGE_NAME}-${runtime_lang}" \
                --build-arg "JETSCALE_VERSION=${VERSION}" \
                --build-arg "JETSCALE_GIT_SHA=${SHA_FULL}" \
                --build-arg "JETSCALE_BUILD_TIME=${BUILD_TIME}" \
                --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
                --label "org.opencontainers.image.version=${VERSION}" \
                --label "org.opencontainers.image.revision=${SHA_FULL}" \
                --label "org.opencontainers.image.created=${BUILD_TIME}" \
                --push \
                --cache-from type=gha,scope=run-${runtime_lang} \
                --cache-to type=gha,mode=max,scope=run-${runtime_lang} \
                $(echo "${TAGS_RUN}" | tr ',' '\n' | sed 's/^/--tag /') .
            done
          fi

          # --- 2. Base/Polyglot Images (Runs for everyone) ---
          echo "Processing Base/Polyglot images..."

          # DEV Image
          GHCR_DEV_POLY="ghcr.io/${OWNER_LC}/${IMAGE_NAME}-dev"
          DH_DEV_POLY=""
          if [[ "${{ inputs.publish_to_dockerhub }}" == "true" && "$HAS_DOCKERHUB" == "true" ]]; then
             DH_DEV_POLY="docker.io/${DOCKERHUB_USERNAME}/${IMAGE_NAME}-dev"
          fi
          TAGS_DEV_POLY=$(generate_tags "$GHCR_DEV_POLY" "$DH_DEV_POLY")

          echo "Building Base/Polyglot Dev: ${TAGS_DEV_POLY}"
          docker buildx build \
            --file "${{ inputs.dockerfile }}" \
            --target "${IMAGE_NAME}-dev" \
            --build-arg "JETSCALE_VERSION=${VERSION}" \
            --build-arg "JETSCALE_GIT_SHA=${SHA_FULL}" \
            --build-arg "JETSCALE_BUILD_TIME=${BUILD_TIME}" \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.version=${VERSION}" \
            --label "org.opencontainers.image.revision=${SHA_FULL}" \
            --label "org.opencontainers.image.created=${BUILD_TIME}" \
            --push \
            --cache-from type=gha,scope=dev-polyglot \
            --cache-to type=gha,mode=max,scope=dev-polyglot \
            $(echo "${TAGS_DEV_POLY}" | tr ',' '\n' | sed 's/^/--tag /') .

          # RUNTIME Image
          GHCR_RUN_POLY="ghcr.io/${OWNER_LC}/${IMAGE_NAME}"
          DH_RUN_POLY=""
          if [[ "${{ inputs.publish_to_dockerhub }}" == "true" && "$HAS_DOCKERHUB" == "true" ]]; then
             DH_RUN_POLY="docker.io/${DOCKERHUB_USERNAME}/${IMAGE_NAME}"
          fi
          TAGS_RUN_POLY=$(generate_tags "$GHCR_RUN_POLY" "$DH_RUN_POLY")

          echo "Building Base/Polyglot Runtime: ${TAGS_RUN_POLY}"
          docker buildx build \
            --file "${{ inputs.dockerfile }}" \
            --target "${IMAGE_NAME}" \
            --build-arg "JETSCALE_VERSION=${VERSION}" \
            --build-arg "JETSCALE_GIT_SHA=${SHA_FULL}" \
            --build-arg "JETSCALE_BUILD_TIME=${BUILD_TIME}" \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.version=${VERSION}" \
            --label "org.opencontainers.image.revision=${SHA_FULL}" \
            --label "org.opencontainers.image.created=${BUILD_TIME}" \
            --push \
            --cache-from type=gha,scope=run-polyglot \
            --cache-to type=gha,mode=max,scope=run-polyglot \
            $(echo "${TAGS_RUN_POLY}" | tr ',' '\n' | sed 's/^/--tag /') .

      - name: Push Git Tag
        if: inputs.push_git_tag && steps.semrel.outputs.version != '' && steps.local_check.outputs.is_local != 'true'
        env:
          VERSION: ${{ steps.semrel.outputs.version }}
          PUSH_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN != '' && secrets.JETSCALEBOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git tag "v${VERSION}"
          git remote set-url origin "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "v${VERSION}"
